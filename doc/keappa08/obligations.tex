%%% -*- mode: LaTeX; TeX-master: "main.tex"; -*-

\ifx\master\undefined
\documentclass[a4paper]{easychair}
\usepackage{submission}
\begin{document}
{\let\master\relax\input{frontmatter}}
\fi
%%%% PLEASE DO NOT EDIT ABOVE THIS LINE

\section{Proof Obligations}
\label{sec:obligations}

The \PM\ computes a separate proof obligation for each % (non-omitted)
leaf proof and orchestrates the back-end provers to verify these
obligations.  Each obligation is independent and can be proved
individually.  If the system cannot verify an obligation within a
reasonable amount of time, the \PM\ reports a failure.  The user must
then determine if it failed because it depends on hidden facts or
definitions, or if the goal is too complex and needs to be refined
with another level of proof.  (Hiding facts or definitions might also
help to constrain the search space of the back-end provers.)

When the back-end provers fail to find a proof, the user will know
which obligation was unprovable---that is, she will be told the
obligation's usable context and goal and the leaf proof from which it
was generated.  We do not yet know if this will be sufficient in
practice or if the \PM will need to provide the user with more
information about why an obligation failed.  For example, many SAT and
SMT solvers produce counterexamples for an unsatisfiable formula that
can provide useful information.

% \llnote{I added the preceding paragraph in response to the following.}
% \ednote{SM}{Should we discuss a bit more what information we expect
%   the \PM and the backend to exchange (note the name of the workshop
%   \ldots)? The user's task would become easier if the back-end
%   reported why it failed. For example, SMT solvers compute a
%   counter-example to the proof obligation.}
% \ednote{KC}{I don't understand what is meant by:
%   \begin{quote}
%     ``\dots the user will need to be told what subgoal Isabelle failed on.''
%   \end{quote}
%   What is a ``subgoal''?}

% If only these separate proof obligations were verified, then an
% error in the way the \PM\ generated any single obligation could make
% the proof incorrect.  We avoid placing so much trust in the \PM\ by
% having it generate an additional \emph{structural} obligation and its
% proof.  The structural obligation asserts simply that the collection
% of all these other obligations implies the correctness of the theorem.
% By verifying the structural obligation's proof, the back-end prover
% asserts that the proofs of all the obligations generated by the \PM
% prove the statement of the theorem.  Assuming that the prover is
% sound, this implies that an error is possible only if the \PM\ made an
% error in stating the (essentially trivial) structural obligation, or
% it incorrectly translated the statement of the theorem into the
% prover's logic.
% %
%
% \llnote{Kaustuv replaced the preceding paragraph with one that says
% so many things that I don't agree with or don't understand that I
% have not attempted to incorporate it.  Instead, I've inserted it
% as a comment with my remarks.
% }
%
% \ednote{KC}{Needless to say, I dislike the previous paragraph very
%   much. My version, uncommented, with explanations below.
%   \begin{quote}
%     The mechanics of the \PM are not trusted. 
%     %
%     \ednote{LL}{What are the ``mechanics'' of the \PM.  If the \PM\
%       isn't trusted, then we don't trust any proof it verifies.
%       %
%       \ednote{KC}{Maybe I should have said ``proof obligation
%         generating procedure'' instead of ``mechanics''. The whole
%         point of certifying with Isabelle/\tlaplus is that we don't
%         have to trust whatever voodoo the PM does.}
%       %
%     }
%     %
%
%    Instead, the \PM proves that the obligations it computes for a
%    given proof will successfully lead to a proof of the goal.  Thus,
%    a bug in the \PM that causes it to emit incorrect obligations, or
%    miss important obligations, will not cause the user to believe her
%    \tlatwo proof is checked when indeed it is wrong.
%
%    \ednote{LL}{This is nonsense.  If the \PM\ produces TRUE as as the
%      goal, how does proving that the proof obligations ``lead to it''
%      (whatever that means) prove anything?
%      %
%      \ednote{KC}{Please \textit{reread} the paragraph, particularly
%        the end. We have said that the embedding of \tlaplus to
%        Isabelle/\tlaplus is trusted. If it performs an unsound
%        translation, such as translating \FALSE to \TRUE, then all bets
%        are off.
%        %
%      }
%      %
%    }
%
%    This sufficiency proof proves a \textit{structure theorem}, which
%    is an Isabelle/TLA+ meta-implication
%
%    \ednote{LL}{What is a meta-implication?
%      %
%      \ednote{KC}{An implication in the Isabelle meta-language. What is
%        a ``meta equality'', you may as well ask. You didn't have a
%        problem with that when Stephan suggested it.}
%    %
%    }
%
%    from the proof obligations to the goal of the proof, and is
%    rendered as an Isar proof script that is certified by
%    Isabelle/\tlaplus.  This proof is also statically computed,
%    requiing no proof search in its construction or certification.
%    The composition of the structure theorem and the proof
%    obligations is then a complete proof of the original goal,
%    certified by Isabelle/\tlaplus.
%  
%    \ednote{LL}{ In a previous email, you indicated that the proof of
%      what we were then calling the structure lemma does not contain
%      proofs of the individual obligations.  You now are contradicting
%      that.  Indeed, your 4-step description of how the structural
%      lemma was used did not show any proofs of obligations in the Isar
%      scripts sent to Isabelle.
%      %
%      \ednote{KC}{I fail to see any contradiction. This entire
%        paragraph depends on the individual proof obligations being
%        certified earlier. It could be made clearer, perhaps.}
%    %
%    }
%
%    Assuming that the Isabelle kernel is sound, and trusting the
%    embedding of \tlatwo into Isabelle/\tlaplus, the user may
%    therefore conclude that her proof is indeed correct.
%
%    \ednote{LL}{ So we're not willing to trust the PM to do the
%      horribly difficult task of making sure it sends every obligation
%      to the back-end to be checked, but we're willing to trust that
%      there are no errors in the trivial task of correctly embedding
%      \tlatwo\ in Isabelle (which includes both the translation to
%      Isabelle/\tlaplus and the axioms of Isabelle/\tlaplus?)
%      %
%      \ednote{KC}{Roughly, yes. We can't not trust the embedding, the
%        axiomatization, and the soundness of the Isabelle kernel.}
%    %
%    }
%    
%   \end{quote}
% }
%
% As an additional safeguard against possibly unsound provers, we
% require them to produce a proof whose correctness can be certified by
% Isabelle's kernel, the only ultimately trusted formalism.
% 
% \ednote{SM}{I added the last sentence of the preceding paragraph in
%   response to Leslie's request at the end of
%   Sect.~\ref{sec:obligations}.
% \llnote{I removed it because we explicitly say that we don't require it.}
% }
%
% \llnote{This is a question for Kaustuv.  The answer probably won't
% change what we've written.\\[.2em]
% %
% I still don't understand the structural obligation.  Kaustuv
% agreed that for a proof consisting of a sequence of steps ending with
% QED, all of whose proofs are omitted, the structural obligation would
% simply assert that the goal implies itself.  How does adding a BY
% proof of the QED step change the obligation?  How does adding a BY
% proof of one of the other steps change the obligation?  How does
% adding a non-leaf proof of one of these steps change the obligation?
% }

%%% The following two paragraphs is my attempt at reconciling
%%% the various bits of disagreement. -- KC

% The \PM will also mediate the \emph{certification} of the \tlatwo
% proof in a formal axiomatization of \tlatwo in a trusted logical
% framework, which in the current design is Isabelle/\tlaplus (described
% in section~\ref{sec:backend.isa}). Although the \PM is designed
% generically and can support other similar frameworks, for the rest of
% this paper we will limit our attention to Isabelle/\tlaplus.

% As each proof obligation is proved by back-end provers, the proofs are
% certified by Isabelle/\tlaplus---that is, the Isabelle kernel is
% convinced that the obligation is true. After all the obligations are
% certified, and assuming no sub-proof was omitted in the \tlatwo proof,
% the \PM will then write an Isar proof that Isabelle/\tlaplus will
% certify as a proof of the overall theorem. This proof uses a
% \emph{structure lemma}, which is an Isabelle meta-implication from the
% proof obligations to the overall theorem, and can be seen as a
% certificate of correctness of the proof-obligation generation
% procedure in the \PM. Once Isabelle certifies that the composition of
% the structure lemma and the individual proof obligations it had
% certified earlier is a proof of the overall theorem, we may conclude
% that the overall theorem is true assuming the embedding of \tlatwo
% into Isabelle/\tlaplus is sound. Note that none of the back-end
% provers, nor the proof obligation generating procedure in the \PM, are
% ultimately trusted.

%% And this is my attempt -- DD

The \PM will also mediate the \emph{certification} of the \tlatwo
proof in a formal axiomatization of \tlatwo in a trusted logical
framework, which in the current design is Isabelle/\tlaplus (described
in Section~\ref{sec:backend.isa}). Although the \PM is designed
generically and can support other similar frameworks, for the rest of
this paper we will limit our attention to Isabelle/\tlaplus.
%
Assuming that Isabelle/\tlaplus is sound, once it has certified a
theorem we know that an error is possible only if the \PM incorrectly
translated the statement of the theorem into Isabelle/\tlaplus.

After certifying each obligation, certification of the theorem itself
is achieved in two steps. First, the \PM generates a \emph{structure
  lemma} (and its Isabelle/\tlaplus proof) that states simply that the
collection of proof obligations implies the theorem.  Then, the \PM
generates a proof of the theorem that uses the already-certified
obligations and structure lemma.
%%% Do we need to make the following explicit ?
% Note that it is the certifier's job to check that they are already
% certified.  We don't depend on the \PM for that.
When the certifier accepts that proof, we get the assurance that the
translated version of the theorem is true, regardless of any errors
the \PM might have made.

%%%

Of course, we expect the \PM\ to be correct.  We now explain why it
should be by describing how it generates the proof obligations from
the proof of a theorem. (Remember that we are considering only \tlatwo
formulas with no temporal operators.)
%
% We use a slightly enhanced version of \tlatwo\ in which
% assumptions (\ASSUME\ clauses) can include definitions, and we write
% "hide h" to indicate that an assumption $h$ is hidden.  (However,
% remember that we are considering only \tlatwo\ formulas with constants
% and no temporal operators.)  If $\Gamma$ is a sequence of assumptions,
% we let "\obl{\G ||- e}" be an abbreviation for $\ASSUME\ \Gamma\
% \PROVE\ e$, or for $e$ if $\Gamma$ is empty.  
%
%%% It is misleading to say assertions are an enhanced form of TLA+
%%% because they are in the TLA+ *meta* logic.
%
A theorem in \tlatwo represents a closed \emph{assertion} in the
\tlatwo meta-logic of the form "\obl{\G ||- e}", where "\G" is a
\emph{context} containing all the declarations, definitions, facts
(previous assumptions or theorems) and the assumptions introduced in
the theorem using an \ASSUME clause (if present), and "e" is a \tlatwo
formula that is the \emph{goal} of the theorem.

\ednote{SM}{I side with Leslie here. Also note that ``existence of an
  Isabelle/\tlaplus proof'' is at least ambiguous. Assuming that the
  encoding of \tlaplus in Isabelle is complete (as it should be), this
  just means ``semantically true'', but is useless because we have no
  clue how to find this proof. For me, ``verifiable'' is constructive:
  we have a proof method (or back-end) that gives us the proof. Below
  is my suggestion. I don't feel a need to talk about hiding in any
  more detail at this point, but feel free to add it back in if you
  think otherwise.}

A closed assertion is said to be \textit{true} if $e$ is entailed by
$\G$ in the formal semantics of \tlaplus~\cite{lamport03tla}. It is
said to be \emph{verifiable} if we have a proof of $e$ from $\G$ in
Isabelle/\tlaplus. Because we assume Isabelle/\tlaplus to be sound,
any verifiable assertion is true. The \PM follows the structure of
the \tlatwo proof to refine the initial assertion into \emph{proof
  obligations} that
represent the individual steps of the \tlatwo proof. 
The proof is accepted by the \PM if all proof
obligations are verifiable, with the back-end provers generating the
necessary Isabelle/\tlaplus proofs. While traversing the \tlatwo
proof, the \PM also generates the structure lemma and its proof, which
is then certified by Isabelle/\tlaplus. Together with the proof
obligations certified earlier, Isabelle/\tlaplus then has a complete
certified proof of the overall obligation.
% \ednote{DD}{I edited the previous sentence to make it consistent with
% the new ``trust'' description.\\[.4em]
%SM: reverted to ``assertion'' and keeping ``proof obligation'' for the
%leaves because that's also the terminology of the appendix.}

A \emph{claim} is a sentence of the form "\pi:\obl{\G ||- e}", where
$\pi$ is a \tlatwo\ proof, representing the verification task that
$\pi$ is a proof of the assertion "\obl{\G ||- e}". The \PM
generates the proof obligations of a claim by recursively traversing its
proof, using its structure to transform the assertion. Each proof step
results in a modification of the current context or goal, and the
final \QED step proves the assertion obtained as a result of these
transformations. A claim
is \emph{meaningful} if this transformation is defined for every step of
the proof. (An example of a meaningless claim is one that involves a
\TAKE\ step whose assertion does not have a universally quantified
goal.) Precisely, every step defines a transformation,
written
% \begin{gather*} \small
$
  "\sigma.\,\tau: \obl{\G ||- e} --> \obl{\D ||- f}"
$,
% \end{gather*}
which states that the assertion "\obl{\G ||- e}" is changed to the
assertion "\obl{\D ||- f}" by the step "\sigma.\,\tau".

\llnote{I changed ``refined'' to ``changed'' above because I don't see
any refinement going on.  But I'm not adamant about that.\\[.3em]
Also, I think ``the assertion'' is going to confuse people because
we use ``assertion' in different ways.  It would be
better if we introduced the notion
of a \emph{current} assertion in a proof, so we could talk about a
current assertion here instead of just ``the assertion''.}

\ednote{KC}{It is always going to be a refinement because the truth of
  the ``thing'' to the right of "-->" implies the truth of that to the
  left.\\[1ex]
  I agree about confusing confusing the ``thing'' "\obl{\G ||- e}"
  with assertion steps. I had called them obligations from the start
  for \textit{this very reason} and was very surprised that you
  preferred the more confusing conflation. I am going back to my
  original terminology.\\[.4em]
SM: I don't quite understand the fuzz. Assertions are transformed, and
``obligations'' have been introduced as assertions at the leaves, so
why not leave it at that. A possible confusion may arise if it is not
clear to which assertion we refer at any given point, but I hope the
wording is now sufficiently clear.
}

The recursive generation of proof obligations for claims and
transformations is specified using inference rules, with the
interpretation that the proof obligations of the claim or
transformation at the conclusion of a rule is the union of the proof
obligations of those at the premises of the rule.  For example, the
following rule is applied to generate the proof obligations for a
claim "\pi:\obl{\G ||- e}" when $\pi$ is a sequence of $n$ steps, for
$n>1$.
%
\begin{gather*} \small
  \I{"\sigma_1.\,\tau_1 \ \ \sigma_2.\,\tau_2 \ \ \dotsb \ \ \sigma_n.\,\tau_n : \obl{\G ||- e}"}
    {"\sigma_1.\,\tau_1 : \obl{\G ||- e} --> \obl{\D ||- f}"
     &
     "\sigma_2.\,\tau_2 \ \ \dotsb \ \ \sigma_n.\,\tau_n : \obl{\D ||- f}"}
\end{gather*}
As an example of proof obligations generated by a transformation, here
is a rule for a step numbered with the begin-step level token $\s{n}$
that asserts "a" and has the proof $\pi$.
\begin{gather*} \small
  \I{"\s{n}.\ a\ \PROOF\ \pi : \obl{\G ||- e} --> \obl{\G, a ||- e}"}
    {"\pi : \obl{\G, \hide{\lnot e} ||- a}"}
\end{gather*}
The rule concludes that the result of this step is to add "a" to
the context, assuming that the sub-proof "\pi" is able to establish
it.
% (If the step-starting token were a label $\s{n}l$, then "a" would
% have been hidden in the result and "\s{n}l\DEF a" would have been
% added as a usable definition.)
%%   that's just a distraction here -- KC
% The proof obligations generated by this transformation are the same as
% those of the claim in the premise of the rule. 
%%   redundant as we have already said what a rule means
The input goal "e" is negated and added to the context hidden, written
"\hide{\lnot e}", in the premise; it can be added to the context
because the logic is classical, and can simplify subproofs which may
now appeal to "\lnot e" with \BY or \USE.  A complete set of such
rules is given in the appendix.

These rules generate proof obligations for any meaningful claim. The
\PM instructs the back end to prove the claims after
%\textit{filtering} all hidden assumptions from them, which amounts to
deleting hidden facts and replacing operator definitions with
declarations.
% ; these filtered obligations are consequently certified in
% Isabelle/\tlaplus. 
The \PM can then construct a proof of the overall assertion
that uses the (already certified) leaf obligations;
the following meta-theorem (whose proof appears in
appendix~\ref{apx:constraints}) justifies the correctness of this
approach.
%
\begin{thm}[Structural Soundness Theorem] \label{thm:meaning}
  % 
  If "\pi:\obl{\G ||- e}" is a meaningful claim and the proof
  obligations it generates all verifiable, then "\obl{\G ||- e}" is
  true.
\end{thm}

%%%% PLEASE DO NOT EDIT BELOW THIS LINE
\ifx\master\undefined
{\let\master\relax\input{rearmatter}}
\end{document}
\fi
